<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×ª×•×— ×”×ª×¤×ª×—×•×ª×™</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            direction: rtl;
            padding-bottom: 110px; /* space for fixed footer */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* heading-with-logos */
        .heading-with-logos {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }
        .heading-with-logos .logo-left,
        .heading-with-logos .logo-right {
            height: 40px;
            width: auto;
            object-fit: contain;
            border-radius: 6px;
        }
        .heading-with-logos .title-text {
            display: inline-block;
        }

        /* ============ MAIN MENU ============ */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            animation: fadeIn 0.8s ease-out;
        }

        .main-menu.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .menu-header { text-align: center; margin-bottom: 50px; }

        .menu-header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            gap: 16px;
            justify-content: center;
        }

        .menu-header p { font-size: 1.2rem; color: #6b7280; }

        .menu-cards { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; }

        .menu-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 320px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.4s ease;
            border: 3px solid transparent;
        }

        .menu-card:hover { transform: translateY(-10px); box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .menu-card.milestones:hover { border-color: #667eea; }
        .menu-card.subjective:hover { border-color: #10b981; }

        .menu-card-icon { width: 100px; height: 100px; margin: 0 auto 25px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:3rem; }

        .menu-card.milestones .menu-card-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .menu-card.subjective .menu-card-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }

        .menu-card h2 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 15px; }
        .menu-card p { font-size: 0.95rem; color: #6b7280; line-height: 1.6; }

        /* ============ SHARED STYLES ============ */
        .app-container { display: none; }
        .app-container.active { display: block; animation: fadeIn 0.6s ease-out; }

        .back-button {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; font-family: 'Heebo', sans-serif;
            margin-bottom: 30px;
        }
        .back-button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(107,114,128,0.3); }

        .header { text-align: center; margin-bottom: 50px; animation: fadeInDown 0.8s ease-out; }
        @keyframes fadeInDown { from { opacity:0; transform: translateY(-30px);} to { opacity:1; transform: translateY(0);} }

        .header h1 {
            font-size: 2.5rem; font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 16px;
            justify-content: center;
        }

        .header p { font-size: 1.1rem; color: #6b7280; }

        /* Upload Card */
        .upload-card { background: white; border-radius: 24px; padding: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom:40px; text-align:center; }
        .upload-area { border: 3px dashed #d1d5db; border-radius:20px; padding:60px 40px; cursor:pointer; transition:all 0.3s ease; background: linear-gradient(135deg,#fafbfc 0%,#f3f4f6 100%); }
        .upload-area:hover { border-color:#667eea; background: linear-gradient(135deg,#f0f1ff 0%,#e8e9ff 100%); transform: scale(1.01); }
        .upload-icon { width:80px; height:80px; margin:0 auto 20px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{ box-shadow:0 0 0 0 rgba(102,126,234,0.4);} 50%{ box-shadow:0 0 0 20px rgba(102,126,234,0); } }
        .upload-text { font-size:1.3rem; font-weight:600; color:#374151; margin-bottom:8px; }
        .upload-subtext { font-size:0.95rem; color:#9ca3af; }
        .file-input { display:none; }

        /* Loading */
        .loading { display:none; text-align:center; padding:40px; }
        .loading.active { display:block; }
        .spinner { width:50px; height:50px; border:4px solid #e5e7eb; border-top-color: #667eea; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Dashboard / Section / tables / charts - keep as before */
        .section { background:white; border-radius:24px; padding:40px; box-shadow:0 10px 40px rgba(0,0,0,0.08); margin-bottom:30px; }
        .section-title {
            font-size:1.6rem; font-weight:700; color:#1f2937; margin-bottom:25px; text-align:center;
            padding-bottom:15px; border-bottom:3px solid #667eea;
            display:inline-flex; align-items:center; gap:10px; justify-content:center;
        }

        .stats-row { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-bottom:30px; }
        .stat-badge { display:inline-flex; align-items:center; gap:8px; background: linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%); padding:12px 20px; border-radius:50px; font-weight:600; font-size:0.95rem; color:#374151; }
        .stat-badge.boys { background: linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%); color:#1e40af; }
        .stat-badge.girls { background: linear-gradient(135deg,#fce7f3 0%,#fbcfe8 100%); color:#be185d; }
        .stat-badge.age { background: linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%); color:#065f46; }
        .stat-badge.total { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }

        .chart-container { position:relative; height:350px; margin-bottom:20px; }
        .data-table { width:100%; border-collapse:collapse; margin-top:20px; }
        .data-table th { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:14px 18px; text-align:right; font-weight:600; }
        .data-table th:first-child { border-radius: 0 12px 0 0; }
        .data-table th:last-child { border-radius: 12px 0 0 0; }
        .data-table td { padding:14px 18px; border-bottom:1px solid #e5e7eb; color:#374151; }
        .data-table tr:hover td { background:#f9fafb; }

        .percentage-bar { display:flex; align-items:center; gap:12px; }
        .bar-container { flex:1; height:12px; background:#e5e7eb; border-radius:6px; overflow:hidden; }
        .bar-fill { height:100%; border-radius:6px; transition: width 1s ease-out; }
        .color-social { background: linear-gradient(90deg,#c4b5fd 0%,#a78bfa 100%); }
        .color-language { background: linear-gradient(90deg,#fdba74 0%,#fb923c 100%); }
        .color-gross { background: linear-gradient(90deg,#7dd3fc 0%,#38bdf8 100%); }
        .color-fine { background: linear-gradient(90deg,#86efac 0%,#4ade80 100%); }

        /* Buttons */
        .buttons-row { display:flex; gap:15px; justify-content:center; flex-wrap:wrap; margin-top:20px; }
        .btn { display:inline-flex; align-items:center; gap:8px; padding:12px 24px; border-radius:12px; font-size:0.95rem; font-weight:600; cursor:pointer; transition:all 0.3s ease; border:none; font-family: 'Heebo', sans-serif; }
        .btn:hover { transform: translateY(-2px); }
        .btn-save { background: linear-gradient(135deg,#10b981 0%,#059669 100%); color:white; }
        .btn-pdf { background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%); color:white; }
        .btn-reset { background: linear-gradient(135deg,#6b7280 0%,#4b5563 100%); color:white; }
        .btn-excel { background: linear-gradient(135deg,#17a2b8 0%,#138496 100%); color:white; }

        /* Footer (fixed) - stacked: text then centered image */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: rgba(255,255,255,0.98);
            padding: 10px 20px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
            z-index: 9999;
        }

        .footer p { margin: 0; font-size: 0.95rem; color: #9ca3af; text-align:center; }
        .footer .logo { height: 56px; object-fit: contain; display:block; }

        /* Subjective-specific and responsive tweaks */
        .charts-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:20px; margin-bottom:25px; }
        .chart-card { background:#fafafa; border-radius:10px; padding:20px; border:1px solid #eee; }
        .chart-title { font-size:1.1em; color:#34495e; margin-bottom:15px; text-align:center; font-weight:600; }
        .chart-wrapper { display:flex; justify-content:center; margin-bottom:15px; }
        canvas.pie-chart { max-width:180px; max-height:180px; }

        @media (max-width: 992px) { .charts-grid { grid-template-columns: repeat(2,1fr); } }
        @media (max-width: 768px) {
            .menu-header h1 { font-size: 2rem; }
            .menu-cards { flex-direction: column; align-items: center; }
            .menu-card { width: 100%; max-width: 320px; }
            .header h1 { font-size: 2rem; }
            .upload-card { padding: 30px; }
            .chart-container { height: 280px; }
            .charts-grid { grid-template-columns: 1fr; }
            .group-header { flex-direction: column; align-items: flex-start; }
            .heading-with-logos .logo-left,
            .heading-with-logos .logo-right { height: 28px; }
            body { padding-bottom: 130px; }
        }
    </style>
</head>
<body>
    <!-- ============ MAIN MENU ============ -->
    <div class="main-menu" id="mainMenu">
        <div class="menu-header">
            <h1>
                <span class="heading-with-logos">
                    <img class="logo-left" src="sderot.jpg" alt="Sderot logo">
                    <span class="title-text"> ××¢×¨×›×ª × ×™×ª×•×— ×”×ª×¤×ª×—×•×ª×™</span>
                    <img class="logo-right" src="drech_hakesher.jpg" alt="Drech Hakesher logo">
                </span>
            </h1>
            <p>×‘×—×¨ ××ª ×¡×•×’ ×”× ×™×ª×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×¦×¢</p>
        </div>

        <div class="menu-cards">
            <div class="menu-card milestones" onclick="showApp('milestones')">
                <div class="menu-card-icon">ğŸ“Š</div>
                <h2>× ×™×ª×•×— ××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª</h2>
                <p>× ×™×ª×•×— ×¢××™×“×” ×‘××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª ×‘×ª×—×•××™×: ×—×‘×¨×”, ×©×¤×”, ××•×˜×•×¨×™×§×” ×’×¡×” ×•××•×˜×•×¨×™×§×” ×¢×“×™× ×”</p>
            </div>

            <div class="menu-card subjective" onclick="showApp('subjective')">
                <div class="menu-card-icon">ğŸ“‹</div>
                <h2>× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™</h2>
                <p>× ×™×ª×•×— ×©××œ×•× ×™ ×”×ª× ×”×’×•×ª: ×¤×—×“, ××›×™×œ×”, ××œ×™××•×ª, ×‘×›×™ ×××•×©×š, ×”×ª×¤×¨×¦×•×™×•×ª, ×©×™× ×” ×•× ×¡×™×’×”</p>
            </div>
        </div>
    </div>

    <!-- ============ MILESTONES APP ============ -->
    <div class="app-container" id="milestonesApp">
        <div class="container">
            <button class="back-button" onclick="goToMenu()">â†’ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>

            <header class="header">
                <h1>
                    <span class="heading-with-logos">
                        <img class="logo-left" src="sderot.jpg" alt="Sderot logo">
                        <span class="title-text">ğŸ“Š × ×™×ª×•×— ××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª</span>
                        <img class="logo-right" src="drech_hakesher.jpg" alt="Drech Hakesher logo">
                    </span>
                </h1>
                <p>×”×¢×œ×” ×§×•×‘×¥ CSV ××• Excel ×œ× ×™×ª×•×— ××¢×•×Ÿ ×•×›×™×ª×•×ª</p>
            </header>

            <div class="upload-card" id="milestonesUploadCard">
                <div class="upload-area" id="milestonesUploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <p class="upload-text">×’×¨×•×¨ ×§×•×‘×¥ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</p>
                    <p class="upload-subtext">×ª×•××š ×‘-CSV ×•-Excel (.xlsx, .xls)</p>
                </div>
                <input type="file" class="file-input" id="milestonesFileInput" accept=".csv,.xlsx,.xls">
            </div>

            <div class="loading" id="milestonesLoading">
                <div class="spinner"></div>
                <p>××¢×‘×“ ××ª ×”× ×ª×•× ×™×...</p>
            </div>

            <div class="dashboard" id="milestonesDashboard"></div>
        </div>
    </div>

    <!-- ============ SUBJECTIVE APP ============ -->
    <div class="app-container" id="subjectiveApp">
        <div class="container">
            <button class="back-button" onclick="goToMenu()">â†’ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>

            <header class="header">
                <h1 style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; background-clip: text;">
                    <span class="heading-with-logos">
                        <img class="logo-left" src="sderot.jpg" alt="Sderot logo">
                        <span class="title-text">ğŸ“‹ × ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™</span>
                        <img class="logo-right" src="drech_hakesher.jpg" alt="Drech Hakesher logo">
                    </span>
                </h1>
                <p>×”×¢×œ×” ×§×•×‘×¥ CSV ××• Excel ×œ× ×™×ª×•×— × ×ª×•× ×™ ×”×ª× ×”×’×•×ª ×œ×¤×™ ×›×™×ª×•×ª</p>
            </header>

            <div class="upload-card" id="subjectiveUploadCard">
                <div class="upload-area" id="subjectiveUploadArea" style="border-color: #10b981;">
                    <div class="upload-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ğŸ“</div>
                    <p class="upload-text">×’×¨×•×¨ ×§×•×‘×¥ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</p>
                    <p class="upload-subtext">×ª×•××š ×‘-CSV ×•-Excel (.xlsx, .xls)</p>
                </div>
                <input type="file" class="file-input" id="subjectiveFileInput" accept=".csv,.xlsx,.xls">
            </div>

            <div class="loading" id="subjectiveLoading">
                <div class="spinner" style="border-top-color: #10b981;"></div>
                <p>××¢×‘×“ ××ª ×”× ×ª×•× ×™×...</p>
            </div>

            <div id="subjectiveGlobalLegend" class="global-legend">
                <h3>ğŸ¨ ××§×¨× ×¦×‘×¢×™×</h3>
                <div class="global-legend-items">
                    <div class="global-legend-item">
                        <div class="legend-color-box" style="background: #FFF3B0;"></div>
                        <span>×¢×¨×š 3 - ×§×•×©×™ ×§×œ</span>
                    </div>
                    <div class="global-legend-item">
                        <div class="legend-color-box" style="background: #FFD6A5;"></div>
                        <span>×¢×¨×š 4 - ×§×•×©×™ ×‘×™× ×•× ×™</span>
                    </div>
                    <div class="global-legend-item">
                        <div class="legend-color-box" style="background: #FFADAD;"></div>
                        <span>×¢×¨×š 5 - ×§×•×©×™ ××©××¢×•×ª×™</span>
                    </div>
                    <div class="global-legend-item">
                        <div class="legend-color-box" style="background: #FFFFFF; border: 1px solid #ccc;"></div>
                        <span>××—×¨ - ×œ×œ× ×§×•×©×™ ××©××¢×•×ª×™</span>
                    </div>
                </div>
            </div>

            <div class="dashboard" id="subjectiveDashboard"></div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <h3 id="modalTitle">××™×™×¦×...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="progress-text" id="progressText">××›×™×Ÿ ××ª ×”×§×•×‘×¥...</p>
            <p class="progress-detail" id="progressDetail"></p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf || {};

        // Helper to create section titles with one logo on each side (optional reuse)
        function createSectionTitle(titleText, includeLogos = true) {
            const titleEl = document.createElement('div');
            titleEl.className = 'section-title';

            const wrapper = document.createElement('span');
            wrapper.className = 'heading-with-logos';

            if (includeLogos) {
                const left = document.createElement('img');
                left.className = 'logo-left';
                left.src = 'sderot.jpg';
                left.alt = 'Sderot logo';

                const right = document.createElement('img');
                right.className = 'logo-right';
                right.src = 'drech_hakesher.jpg';
                right.alt = 'Drech Hakesher logo';

                wrapper.appendChild(left);
                const txt = document.createElement('span');
                txt.className = 'title-text';
                txt.textContent = titleText;
                wrapper.appendChild(txt);
                wrapper.appendChild(right);
            } else {
                const txt = document.createElement('span');
                txt.className = 'title-text';
                txt.textContent = titleText;
                wrapper.appendChild(txt);
            }

            titleEl.appendChild(wrapper);
            return titleEl;
        }

        // ============ NAVIGATION ============
        function showApp(appType) {
            document.getElementById('mainMenu').classList.add('hidden');
            if (appType === 'milestones') {
                document.getElementById('milestonesApp').classList.add('active');
            } else if (appType === 'subjective') {
                document.getElementById('subjectiveApp').classList.add('active');
            }
        }

        function goToMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('milestonesApp').classList.remove('active');
            document.getElementById('subjectiveApp').classList.remove('active');

            // Reset milestones
            if (typeof milestonesReset === 'function') milestonesReset();

            // Reset subjective
            if (typeof subjectiveReset === 'function') subjectiveReset();
        }

        // ============ MILESTONES APP ============
        const milestonesUploadArea = document.getElementById('milestonesUploadArea');
        const milestonesFileInput = document.getElementById('milestonesFileInput');
        const milestonesUploadCard = document.getElementById('milestonesUploadCard');
        const milestonesLoading = document.getElementById('milestonesLoading');
        const milestonesDashboard = document.getElementById('milestonesDashboard');

        let milestonesAllData = null;
        let milestonesOrgName = '';
        let milestonesCharts = {};
        let milestonesSectionsData = {};

        const hebrewNames = {
            'UnusualSocial': '×—×‘×¨×”',
            'UnusualFineMotor': '××•×˜×•×¨×™×§×” ×¢×“×™× ×”',
            'UnusualLanguage': '×©×¤×”',
            'UnusualGrossMotor': '××•×˜×•×¨×™×§×” ×’×¡×”'
        };

        const milestonesColors = {
            '×—×‘×¨×”': { bg: 'rgba(196, 181, 253, 0.8)', border: '#a78bfa' },
            '×©×¤×”': { bg: 'rgba(253, 186, 116, 0.8)', border: '#fb923c' },
            '××•×˜×•×¨×™×§×” ×’×¡×”': { bg: 'rgba(125, 211, 252, 0.8)', border: '#38bdf8' },
            '××•×˜×•×¨×™×§×” ×¢×“×™× ×”': { bg: 'rgba(134, 239, 172, 0.8)', border: '#4ade80' }
        };

        const colorClasses = {
            '×—×‘×¨×”': 'color-social',
            '×©×¤×”': 'color-language',
            '××•×˜×•×¨×™×§×” ×’×¡×”': 'color-gross',
            '××•×˜×•×¨×™×§×” ×¢×“×™× ×”': 'color-fine'
        };

        milestonesUploadArea.addEventListener('click', () => milestonesFileInput.click());
        milestonesUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); milestonesUploadArea.style.borderColor = '#667eea'; });
        milestonesUploadArea.addEventListener('dragleave', () => milestonesUploadArea.style.borderColor = '#d1d5db');
        milestonesUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            milestonesUploadArea.style.borderColor = '#d1d5db';
            if (e.dataTransfer.files[0]) milestonesProcessFile(e.dataTransfer.files[0]);
        });
        milestonesFileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) milestonesProcessFile(e.target.files[0]);
        });

        function milestonesProcessFile(file) {
            milestonesUploadCard.style.display = 'none';
            milestonesLoading.classList.add('active');

            const reader = new FileReader();

            if (file.name.endsWith('.csv')) {
                reader.onload = (e) => {
                    Papa.parse(e.target.result, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => milestonesAnalyzeData(results.data)
                    });
                };
                reader.readAsText(file);
            } else {
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        milestonesAnalyzeData(jsonData);
                    } catch (err) {
                        alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”-Excel');
                        milestonesLoading.classList.remove('active');
                        milestonesUploadCard.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function readFileText(file, encoding = 'UTF-8') {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(e);
        try {
            reader.readAsText(file, encoding);
        } catch (err) {
            reject(err);
        }
    });
}

/* -- detect columns by heuristics from headers array -- */
function detectColumns(headers) {
    const lower = headers.map(h => (h||'').toString().trim().toLowerCase());

    const pick = (candidates) => {
        for (let cand of candidates) {
            const s = cand.toLowerCase();
            for (let i = 0; i < lower.length; i++) {
                if (lower[i].includes(s)) return headers[i];
            }
        }
        return null;
    };

    const ageField = pick(['patientageincompleted','patient_age_in_completed','age','age_in_months','×’×™×œ','×’×™×œ_×‘×—×•×“×©×™×','age_months']);
    const orgField = pick(['org_name','org','organization','××¢×•×Ÿ','×©×_×”××¢×•×Ÿ','orgname']);
    const clinicField = pick(['clinic_name','clinic','class','×›×™×ª×”','clinicname']);
    const genderField = pick(['gender','sex','××’×“×¨','gender_id']);

    // detect unusual columns by keyword matches
    const mapUnusual = {};
    headers.forEach(h => {
        const key = (h||'').toString().toLowerCase();
        if (key.includes('social') || key.includes('×—×‘×¨×”') || key.includes('social')) mapUnusual['UnusualSocial'] = h;
        if (key.includes('language') || key.includes('×©×¤×”')) mapUnusual['UnusualLanguage'] = h;
        if (key.includes('fine') || key.includes('×¢×“×™× ×”') || key.includes('fine motor') || key.includes('motÃ²r')) mapUnusual['UnusualFineMotor'] = h;
        if (key.includes('gross') || key.includes('×’×¡×”') || key.includes('gross motor')) mapUnusual['UnusualGrossMotor'] = h;
    });

    return { ageField, orgField, clinicField, genderField, mapUnusual };
}

/* -- safe numeric parse -- */
function toNumber(v) {
    if (v === undefined || v === null) return NaN;
    let s = v.toString().trim();
    // remove thousands separators, swap comma decimal if needed
    // if contains both comma and dot assume dot decimal and remove commas
    if (s.indexOf(',') !== -1 && s.indexOf('.') === -1) s = s.replace(',', '.');
    s = s.replace(/\s+/g, '');
    s = s.replace(/,/g, ''); // remove leftover commas
    // remove non-digit except dot and minus
    s = s.replace(/[^0-9.\-]/g, '');
    const n = Number(s);
    return isNaN(n) ? NaN : n;
}

/* -- REPLACEMENT: milestonesProcessFile with encoding & delimiter fallback and debug output -- */
async function milestonesProcessFile(file) {
    milestonesUploadCard.style.display = 'none';
    milestonesLoading.classList.add('active');

    // helper to show debug area
    function showDebug(html) {
        let dbg = document.getElementById('milestonesDebug');
        if (!dbg) {
            dbg = document.createElement('div');
            dbg.id = 'milestonesDebug';
            dbg.className = 'section';
            dbg.style.background = '#fffefc';
            dbg.style.border = '1px dashed #ffd';
            dbg.style.marginTop = '10px';
            milestonesDashboard.parentNode.insertBefore(dbg, milestonesDashboard.nextSibling);
        }
        dbg.innerHTML = html;
    }

    try {
        if (file.name.toLowerCase().endsWith('.csv')) {
            // try utf-8 first
            let text = await readFileText(file, 'UTF-8');

            // quick parse to detect headers
            let results = Papa.parse(text, { header: true, skipEmptyLines: true, preview: 5 });
            // if it seems like single column with semicolons, try semicolon delimiter
            const headerKeys = results.meta && results.meta.fields ? results.meta.fields : Object.keys(results.data[0] || {});
            const singleHeader = headerKeys.length === 1 && headerKeys[0] && headerKeys[0].includes(';');

            if (singleHeader) {
                // reparse with delimiter ;
                results = Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: ';' });
            }

            // if parsed has no headers or looks wrong, try windows-1255
            const hasValid = results && results.data && results.data.length > 0 && Object.keys(results.data[0]).length > 0;
            if (!hasValid) {
                // fallback to windows-1255 encoding
                console.warn('CSV parse looks invalid with UTF-8; trying windows-1255 fallback');
                text = await readFileText(file, 'windows-1255');
                results = Papa.parse(text, { header: true, skipEmptyLines: true });
            }

            console.log('CSV parse preview:', results.data.slice(0,5));
            console.log('CSV headers:', results.meta && results.meta.fields ? results.meta.fields : Object.keys(results.data[0] || {}));
            showDebug(`<h3>Debug: CSV headers & preview</h3><pre>${JSON.stringify({
                headers: results.meta && results.meta.fields ? results.meta.fields : Object.keys(results.data[0] || {}),
                preview: results.data.slice(0,5)
            }, null, 2)}</pre>`);

            milestonesAnalyzeData(results.data);
        } else {
            // Excel path
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                    console.log('Excel first rows:', jsonData.slice(0,5));
                    // show preview
                    let dbgHtml = `<h3>Debug: Excel preview</h3><pre>${JSON.stringify(jsonData.slice(0,5), null, 2)}</pre>`;
                    let dbg = document.getElementById('milestonesDebug');
                    if (!dbg) {
                        dbg = document.createElement('div');
                        dbg.id = 'milestonesDebug';
                        dbg.className = 'section';
                        milestonesDashboard.parentNode.insertBefore(dbg, milestonesDashboard.nextSibling);
                    }
                    dbg.innerHTML = dbgHtml;
                    milestonesAnalyzeData(jsonData);
                } catch (err) {
                    console.error('Excel read error', err);
                    alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”-Excel (×¨××” ×§×•× ×¡×•×œ)');
                    milestonesLoading.classList.remove('active');
                    milestonesUploadCard.style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(file);
        }
    } catch (err) {
        console.error('Unexpected read error:', err);
        alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥. ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ××™×“×¢ × ×•×¡×£.');
        milestonesLoading.classList.remove('active');
        milestonesUploadCard.style.display = 'block';
    }
}

/* -- REPLACEMENT: smarter milestonesAnalyzeData with flexible header mapping -- */
function milestonesAnalyzeData(data) {
    // show immediate debug if nothing
    console.log('milestonesAnalyzeData received rows:', data && data.length);
    if (!data || data.length === 0) {
        alert('×œ× × ××¦××• × ×ª×•× ×™× ×‘×§×•×‘×¥ (0 ×©×•×¨×•×ª). ×‘×“×•×§ ×›×•×ª×¨×•×ª ×•×§×™×“×•×“.');
        milestonesLoading.classList.remove('active');
        milestonesUploadCard.style.display = 'block';
        return;
    }

    const sampleHeaders = Object.keys(data[0]);
    const detected = detectColumns(sampleHeaders);
    console.log('Detected columns mapping:', detected);

    // build function to get value by candidate field name
    const getVal = (row, name) => {
        if (!name) return undefined;
        if (row[name] !== undefined) return row[name];
        // try trimmed keys
        const keys = Object.keys(row);
        for (let k of keys) {
            if (k.trim().toLowerCase() === name.toString().trim().toLowerCase()) return row[k];
        }
        return undefined;
    };

    // filter rows that have valid age (use detected.ageField or fallback by searching possible numeric columns)
    const ageField = detected.ageField;
    const rowsWithAge = data.filter(r => {
        let v = getVal(r, ageField);
        if (v === undefined) {
            // try common numeric columns heuristics
            for (let k of Object.keys(r)) {
                const key = k.toLowerCase();
                if (key.includes('age') || key.includes('g×™×œ') || key.includes('month')) {
                    v = r[k]; break;
                }
            }
        }
        const n = toNumber(v);
        return !isNaN(n);
    });

    if (!rowsWithAge || rowsWithAge.length === 0) {
        // show helpful debug and don't just fail silently
        const dbg = document.getElementById('milestonesDebug');
        const headers = sampleHeaders;
        const preview = data.slice(0,5);
        const html = `<h3>××™×Ÿ ×©×•×¨×•×ª ×¢× ×’×™×œ ×ª×§×™×Ÿ</h3>
            <p>×›×•×ª×¨×•×ª ×©×”×ª×’×œ×•:</p><pre>${JSON.stringify(headers, null, 2)}</pre>
            <p>5 ×©×•×¨×•×ª ×¨××©×•× ×•×ª:</p><pre>${JSON.stringify(preview, null, 2)}</pre>
            <p>× ×¡×” ×œ×•×•×“× ×©×™×© ×¢××•×“×ª ×’×™×œ ××¡×¤×¨×™×ª (×œ×“×•×’××”: "PatientAgeInCompleted" ××• "×’×™×œ").</p>
            <p>×× ×ª×¨×¦×”, ×©×œ×— ×œ×™ ××ª ×”-preivew ×›××Ÿ ×•××¢×“×›×Ÿ ××ª ×”××™×¤×•×™.</p>`;
        if (dbg) dbg.innerHTML = html; else {
            const newDbg = document.createElement('div');
            newDbg.id = 'milestonesDebug';
            newDbg.className = 'section';
            newDbg.innerHTML = html;
            milestonesDashboard.parentNode.insertBefore(newDbg, milestonesDashboard.nextSibling);
        }
        console.warn('No valid age rows found. Headers:', sampleHeaders, 'Preview:', data.slice(0,5));
        alert('×œ× × ××¦××• ×©×•×¨×•×ª ×¢× ×’×™×œ ×ª×§×™×Ÿ. ×‘×“×•×§ ××ª ×›×•×ª×¨×•×ª ×”×§×•×‘×¥. ×¨××• Debug ×‘×ª×—×ª×™×ª ×”×“×£.');
        milestonesLoading.classList.remove('active');
        milestonesUploadCard.style.display = 'block';
        return;
    }

    // continue with original flow but using rowsWithAge
    milestonesAllData = rowsWithAge;
    milestonesOrgName = (rowsWithAge[0][detected.orgField] || rowsWithAge[0]['org_name'] || rowsWithAge[0]['××¢×•×Ÿ'] || '××¢×•×Ÿ') || '××¢×•×Ÿ';
    const classes = [...new Set(rowsWithAge.map(row => (row[detected.clinicField] || row['clinic_name'] || row['class'] || '×œ× ×™×“×•×¢')))];
    console.log('Using', rowsWithAge.length, 'rows after age filter. Org:', milestonesOrgName, 'Classes:', classes);

    setTimeout(() => {
        milestonesLoading.classList.remove('active');
        if (typeof milestonesBuildDashboard === 'function') {
            milestonesBuildDashboard(classes);
        } else {
            const sec = document.createElement('div');
            sec.className = 'section';
            sec.appendChild(createSectionTitle(`××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª ×‘×”×Ÿ ×¢××“×• ×™×œ×“×™ ××¢×•×Ÿ "${milestonesOrgName}"`));
            milestonesDashboard.appendChild(sec);
        }
    }, 300);
}
    </script>

    <!-- Footer ×§×‘×•×¢ ×‘×ª×—×ª×™×ª ×”×“×£: ×˜×§×¡×˜ ×•×œ××—×¨×™×• ×ª××•× ×” ×××•×¨×›×–×ª ××ª×—×ª -->
    <footer class="footer">
        <p>×›×œ×™ × ×™×ª×•×— ××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª | × ×‘× ×” ×¢× â¤ï¸</p>
        <img src="link_car.png" alt="link car" class="logo">
    </footer>
</body>
</html>
