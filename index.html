<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×ª×•×— ×”×ª×¤×ª×—×•×ª×™</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* ============ MAIN MENU ============ */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            animation: fadeIn 0.8s ease-out;
        }

        .main-menu.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .menu-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .menu-header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .menu-header p {
            font-size: 1.2rem;
            color: #6b7280;
        }

        .menu-cards {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .menu-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 320px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.4s ease;
            border: 3px solid transparent;
        }

        .menu-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .menu-card.milestones:hover {
            border-color: #667eea;
        }

        .menu-card.subjective:hover {
            border-color: #10b981;
        }

        .menu-card-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .menu-card.milestones .menu-card-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .menu-card.subjective .menu-card-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .menu-card h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .menu-card p {
            font-size: 0.95rem;
            color: #6b7280;
            line-height: 1.6;
        }

        /* ============ SHARED STYLES ============ */
        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
            animation: fadeIn 0.6s ease-out;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Heebo', sans-serif;
            margin-bottom: 30px;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(107, 114, 128, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: #6b7280;
        }

        /* Upload Card */
        .upload-card {
            background: white;
            border-radius: 24px;
            padding: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 20px;
            padding: 60px 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
        }

        .upload-area:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f1ff 0%, #e8e9ff 100%);
            transform: scale(1.01);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            font-size: 2.5rem;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 0.95rem;
            color: #9ca3af;
        }

        .file-input { display: none; }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active { display: block; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dashboard */
        .dashboard {
            display: none;
            animation: fadeIn 0.6s ease-out;
        }

        .dashboard.active { display: block; }

        /* Section */
        .section {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .class-section {
            border-right: 4px solid #667eea;
            padding-right: 20px;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #374151;
        }

        .stat-badge.boys { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; }
        .stat-badge.girls { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); color: #be185d; }
        .stat-badge.age { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
        .stat-badge.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

        /* Chart */
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 20px;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 18px;
            text-align: right;
            font-weight: 600;
        }

        .data-table th:first-child { border-radius: 0 12px 0 0; }
        .data-table th:last-child { border-radius: 12px 0 0 0; }

        .data-table td {
            padding: 14px 18px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .data-table tr:hover td { background: #f9fafb; }

        .percentage-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bar-container {
            flex: 1;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 1s ease-out;
        }

        .color-social { background: linear-gradient(90deg, #c4b5fd 0%, #a78bfa 100%); }
        .color-language { background: linear-gradient(90deg, #fdba74 0%, #fb923c 100%); }
        .color-gross { background: linear-gradient(90deg, #7dd3fc 0%, #38bdf8 100%); }
        .color-fine { background: linear-gradient(90deg, #86efac 0%, #4ade80 100%); }

        /* Buttons */
        .buttons-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-family: 'Heebo', sans-serif;
        }

        .btn:hover { transform: translateY(-2px); }

        .btn-save { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-save:hover { box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3); }

        .btn-pdf { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-pdf:hover { box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3); }

        .btn-reset { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; }
        .btn-reset:hover { box-shadow: 0 10px 25px rgba(107, 114, 128, 0.3); }

        .btn-excel { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; }
        .btn-excel:hover { box-shadow: 0 10px 25px rgba(23, 162, 184, 0.3); }

        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        /* ============ SUBJECTIVE SPECIFIC STYLES ============ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: #fafafa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #eee;
        }

        .chart-title {
            font-size: 1.1em;
            color: #34495e;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .chart-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        canvas.pie-chart {
            max-width: 180px;
            max-height: 180px;
        }

        .color-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-left: 6px;
            vertical-align: middle;
        }

        .regression-section {
            background: #fff8e1;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #ffe082;
        }

        .regression-title {
            font-size: 1.1em;
            color: #f57c00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .regression-content {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .regression-stat {
            text-align: center;
        }

        .regression-value {
            font-size: 2em;
            font-weight: bold;
            color: #e65100;
        }

        .regression-label {
            font-size: 0.85em;
            color: #666;
        }

        .global-legend {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: none;
        }

        .global-legend h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .global-legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .global-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .group-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #10b981;
        }

        .group-title {
            font-size: 1.5em;
            color: #2c3e50;
        }

        .group-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #10b981;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .group-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .group-export-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-family: 'Heebo', sans-serif;
        }

        .group-export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 1.1em;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 35px;
            border-radius: 15px;
            text-align: center;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            border-radius: 12px;
        }

        .progress-text {
            color: #666;
            font-size: 0.95em;
        }

        .progress-detail {
            color: #999;
            font-size: 0.85em;
            margin-top: 8px;
        }
        .no-difficulty-msg{
          width: 180px;
          height: 180px;
          display: flex;
          align-items: center;
          justify-content: center;
          text-align: center;
          padding: 14px;
          border-radius: 16px;
          background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
          border: 1px solid #22c55e;
          color: #166534;
          font-weight: 700;
        }


        @media (max-width: 992px) {
            .charts-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .menu-header h1 { font-size: 2rem; }
            .menu-cards { flex-direction: column; align-items: center; }
            .menu-card { width: 100%; max-width: 320px; }
            .header h1 { font-size: 2rem; }
            .upload-card { padding: 30px; }
            .chart-container { height: 280px; }
            .charts-grid { grid-template-columns: 1fr; }
            .group-header { flex-direction: column; align-items: flex-start; }
        }
        
        /* ============ HEADER WITH LOGOS ============ */
        .header-with-logos{
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            flex-wrap: wrap;
        }

        .header-logo{
            width: 76px;
            height: 76px;
            object-fit: contain;
            flex: 0 0 auto;
        }
        .link-logo{
            width: 150px;
            height: auto;
        }


        @media (max-width: 768px){
            .header-logo{
                width: 58px;
                height: 58px;
            }
        }

/* ============ FOOTER LOGO ============ */
        .footer{
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .footer-bottom-logo{
            display: block;
            margin: 14px auto 0;
            width: 140px;
            height: auto;
            object-fit: contain;
        }
        .chart-header { margin-bottom: 8px; text-align: center; }
        .chart-title-main { font-size: 17px; font-weight: 700; margin-bottom: 2px; text-align: center;}
        .chart-title-sub { font-size: 13px; color: #4b5563; line-height: 1.3; }

    </style>
</head>
<body>

  <!-- ============ MAIN MENU ============ -->
  <div class="main-menu" id="mainMenu">
    <div class="menu-header">
      <div class="header-with-logos">
        <img class="header-logo" src="branco.jpg" alt="×‘×¨× ×§×•">
        <h1>××¢×¨×›×ª × ×™×ª×•×— ×”×ª×¤×ª×—×•×ª×™</h1>
        <img class="header-logo link-logo" src="link_car.png" alt="×œ×™× ×§">
      </div>
      <p>×‘×—×¨ ××ª ×¡×•×’ ×”× ×™×ª×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×¦×¢</p>
    </div>

    <div class="menu-cards">
      <div class="menu-card milestones" onclick="showApp('milestones')">
        <div class="menu-card-icon">ğŸ“Š</div>
        <h2>× ×™×ª×•×— ××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª</h2>
        <p>× ×™×ª×•×— ×¢××™×“×” ×‘××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª ×‘×ª×—×•××™×: ×—×‘×¨×”, ×©×¤×”, ××•×˜×•×¨×™×§×” ×’×¡×” ×•××•×˜×•×¨×™×§×” ×¢×“×™× ×”</p>
      </div>

      <div class="menu-card subjective" onclick="showApp('subjective')">
        <div class="menu-card-icon">ğŸ“‹</div>
        <h2>× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™</h2>
        <p>× ×™×ª×•×— ×©××œ×•× ×™ ×”×ª× ×”×’×•×ª: ×¤×—×“, ××›×™×œ×”, ××œ×™××•×ª, ×‘×›×™, ×”×ª×¤×¨×¦×•×™×•×ª ×•×©×™× ×”</p>
      </div>
    </div>
  </div>

    <!-- ============ MILESTONES APP ============ -->
    <div class="app-container" id="milestonesApp">
        <div class="container">
            <button class="back-button" onclick="goToMenu()">
                â†’ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™
            </button>

            <header class="header">
                <div class="header-with-logos">
                    <img class="header-logo" src="branco.jpg" alt="×‘×¨× ×§×•">
                    <h1> × ×™×ª×•×— ××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª</h1>
                    <img class="header-logo link-logo" src="link_car.png" alt="×œ×™× ×§">
                </div>
                <p>×”×¢×œ×” ×§×•×‘×¥ CSV ××• Excel ×œ× ×™×ª×•×— ××¢×•×Ÿ ×•×›×™×ª×•×ª</p>
            </header>

            <div class="upload-card" id="milestonesUploadCard">
                <div class="upload-area" id="milestonesUploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <p class="upload-text">×’×¨×•×¨ ×§×•×‘×¥ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</p>
                    <p class="upload-subtext">×ª×•××š ×‘-CSV ×•-Excel (.xlsx, .xls)</p>
                </div>
                <input type="file" class="file-input" id="milestonesFileInput" accept=".csv,.xlsx,.xls">
            </div>

            <div class="loading" id="milestonesLoading">
                <div class="spinner"></div>
                <p>××¢×‘×“ ××ª ×”× ×ª×•× ×™×...</p>
            </div>

            <div class="dashboard" id="milestonesDashboard"></div>
        </div>
    </div>

    <!-- ============ SUBJECTIVE APP ============ -->
    <div class="app-container" id="subjectiveApp">
        <div class="container">
            <button class="back-button" onclick="goToMenu()">
                â†’ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™
            </button>

            <header class="header">
                <div class="header-with-logos">
                    <img class="header-logo" src="branco.jpg" alt="×‘×¨× ×§×•">
                    <h1 id="subjectiveTitleMain"
                        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; background-clip: text;">
                      × ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™
                    </h1>
                    <img class="header-logo link-logo" src="link_car.png" alt="×œ×™× ×§">
                </div>
                <p>×”×¢×œ×” ×§×•×‘×¥ CSV ××• Excel ×œ× ×™×ª×•×— × ×ª×•× ×™ ×”×ª× ×”×’×•×ª ×œ×¤×™ ×›×™×ª×•×ª</p>
            </header>


            <div class="upload-card" id="subjectiveUploadCard">
                <div class="upload-area" id="subjectiveUploadArea" style="border-color: #10b981;">
                    <div class="upload-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ğŸ“</div>
                    <p class="upload-text">×’×¨×•×¨ ×§×•×‘×¥ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</p>
                    <p class="upload-subtext">×ª×•××š ×‘-CSV ×•-Excel (.xlsx, .xls)</p>
                </div>
                <input type="file" class="file-input" id="subjectiveFileInput" accept=".csv,.xlsx,.xls">
            </div>

            <div class="loading" id="subjectiveLoading">
                <div class="spinner" style="border-top-color: #10b981;"></div>
                <p>××¢×‘×“ ××ª ×”× ×ª×•× ×™×...</p>
            </div>

            <div id="subjectiveGlobalLegend" class="global-legend">
                <h3>ğŸ¨ ××§×¨× ×¦×‘×¢×™×</h3>
                <div class="global-legend-items">
                    <div class="global-legend-item">
                        <div class="legend-color-box" style="background: #FFF3B0;"></div>
                        <span>×¢×¨×š 3 - ×§×•×©×™ ×§×œ</span>
                    </div>
                    <div class="global-legend-item">
                        <div class="legend-color-box" style="background: #FFD6A5;"></div>
                        <span>×¢×¨×š 4 - ×§×•×©×™ ×‘×™× ×•× ×™</span>
                    </div>
                    <div class="global-legend-item">
                        <div class="legend-color-box" style="background: #FFADAD;"></div>
                        <span>×¢×¨×š 5 - ×§×•×©×™ ××©××¢×•×ª×™</span>
                    </div>
                    <div class="global-legend-item">
                      <div class="legend-color-box" style="background: #DCFCE7; border: 1px solid #22c55e;"></div>
                      <span>××™×Ÿ ×§×•×©×™ ××“×•×•×— ğŸ˜Š</span>
                    </div>
                </div>
            </div>

            <div class="dashboard" id="subjectiveDashboard"></div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <h3 id="modalTitle">××™×™×¦×...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="progress-text" id="progressText">××›×™×Ÿ ××ª ×”×§×•×‘×¥...</p>
            <p class="progress-detail" id="progressDetail"></p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf || {};

        // ============ NAVIGATION ============
        function showApp(appType) {
            document.getElementById('mainMenu').classList.add('hidden');
            
            if (appType === 'milestones') {
                document.getElementById('milestonesApp').classList.add('active');
            } else if (appType === 'subjective') {
                document.getElementById('subjectiveApp').classList.add('active');
            }
        }

        function goToMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('milestonesApp').classList.remove('active');
            document.getElementById('subjectiveApp').classList.remove('active');
            
            // Reset milestones
            milestonesReset();
            
            // Reset subjective
            subjectiveReset();
        }

        // ============ MILESTONES APP ============
        const milestonesUploadArea = document.getElementById('milestonesUploadArea');
        const milestonesFileInput = document.getElementById('milestonesFileInput');
        const milestonesUploadCard = document.getElementById('milestonesUploadCard');
        const milestonesLoading = document.getElementById('milestonesLoading');
        const milestonesDashboard = document.getElementById('milestonesDashboard');

        let milestonesAllData = null;
        let milestonesOrgName = '';
        let milestonesCharts = {};
        let milestonesSectionsData = {};
        let milestonesReportDate = '';


        const hebrewNames = {
            'UnusualSocial': '×—×‘×¨×”',
            'UnusualFineMotor': '××•×˜×•×¨×™×§×” ×¢×“×™× ×”',
            'UnusualLanguage': '×©×¤×”',
            'UnusualGrossMotor': '××•×˜×•×¨×™×§×” ×’×¡×”'
        };

        const milestonesColors = {
            '×—×‘×¨×”': { bg: 'rgba(196, 181, 253, 0.8)', border: '#a78bfa' },
            '×©×¤×”': { bg: 'rgba(253, 186, 116, 0.8)', border: '#fb923c' },
            '××•×˜×•×¨×™×§×” ×’×¡×”': { bg: 'rgba(125, 211, 252, 0.8)', border: '#38bdf8' },
            '××•×˜×•×¨×™×§×” ×¢×“×™× ×”': { bg: 'rgba(134, 239, 172, 0.8)', border: '#4ade80' }
        };

        const colorClasses = {
            '×—×‘×¨×”': 'color-social',
            '×©×¤×”': 'color-language',
            '××•×˜×•×¨×™×§×” ×’×¡×”': 'color-gross',
            '××•×˜×•×¨×™×§×” ×¢×“×™× ×”': 'color-fine'
        };

        milestonesUploadArea.addEventListener('click', () => milestonesFileInput.click());
        milestonesUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); milestonesUploadArea.style.borderColor = '#667eea'; });
        milestonesUploadArea.addEventListener('dragleave', () => milestonesUploadArea.style.borderColor = '#d1d5db');
        milestonesUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            milestonesUploadArea.style.borderColor = '#d1d5db';
            if (e.dataTransfer.files[0]) milestonesProcessFile(e.dataTransfer.files[0]);
        });
        milestonesFileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) milestonesProcessFile(e.target.files[0]);
        });

        function milestonesProcessFile(file) {
            milestonesUploadCard.style.display = 'none';
            milestonesLoading.classList.add('active');

            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = (e) => {
                    Papa.parse(e.target.result, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => milestonesAnalyzeData(results.data)
                    });
                };
                reader.readAsText(file);
            } else {
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        milestonesAnalyzeData(jsonData);
                    } catch (err) {
                        alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”-Excel');
                        milestonesLoading.classList.remove('active');
                        milestonesUploadCard.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function milestonesAnalyzeData(data) {
            milestonesAllData = data.filter(row => 
                row['PatientAgeInCompleted'] !== undefined && 
                row['PatientAgeInCompleted'] !== '' &&
                !isNaN(Number(row['PatientAgeInCompleted']))
            );

            if (!milestonesAllData || milestonesAllData.length === 0) {
                alert('×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×™× ×™×');
                milestonesLoading.classList.remove('active');
                milestonesUploadCard.style.display = 'block';
                return;
            }
            // ===== ×©××™×¨×ª ×ª××¨×™×š ×¨××©×•×Ÿ ××”×§×•×‘×¥ =====
            if (data.length > 0 && data[0]['Date']) {
                milestonesReportDate = String(data[0]['Date']).trim();
            } else {
                milestonesReportDate = '';
            }


            milestonesOrgName = milestonesAllData[0]['org_name'] || '××¢×•×Ÿ';
            const classes = [...new Set(milestonesAllData.map(row => row['clinic_name'] || '×œ× ×™×“×•×¢'))];

            setTimeout(() => {
                milestonesLoading.classList.remove('active');
                milestonesBuildDashboard(classes);
            }, 300);
        }

        function milestonesGetStats(data) {
            if (!data || data.length === 0) {
                return { total: 0, boys: 0, girls: 0, minAge: 0, maxAge: 0 };
            }
            const ages = data.map(r => Number(r['PatientAgeInCompleted'])).filter(n => !isNaN(n));
            return {
                total: data.length,
                boys: data.filter(r => Number(r['gender']) === 1).length,
                girls: data.filter(r => Number(r['gender']) === 2).length,
                minAge: ages.length ? Math.min(...ages) : 0,
                maxAge: ages.length ? Math.max(...ages) : 0
            };
        }

        function milestonesCalculatePercentages(data) {
            const total = data.length;
            const results = {};
            const unusualColumns = ['UnusualSocial', 'UnusualFineMotor', 'UnusualLanguage', 'UnusualGrossMotor'];

            if (total === 0) {
                unusualColumns.forEach(col => {
                    results[hebrewNames[col]] = { percentage: 0, count: 0, total: 0 };
                });
                return results;
            }

            unusualColumns.forEach(col => {
                let zeroCount = 0;
                data.forEach(row => {
                    if (Number(row[col]) === 0) zeroCount++;
                });
                results[hebrewNames[col]] = {
                    percentage: (zeroCount / total) * 100,
                    count: zeroCount,
                    total: total
                };
            });
            return results;
        }

        function milestonesBuildDashboard(classes) {
            milestonesDashboard.innerHTML = '';
            milestonesCharts = {};
            milestonesSectionsData = {};

            const generalSection = milestonesCreateSection('general', `××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª ×‘×”×Ÿ ×¢××“×• ×™×œ×“×™ ××¢×•×Ÿ "${milestonesOrgName}"`, milestonesAllData);
            milestonesDashboard.appendChild(generalSection);

            classes.forEach((className, index) => {
                const classData = milestonesAllData.filter(r => (r['clinic_name'] || '×œ× ×™×“×•×¢') === className);
                const classSection = milestonesCreateSection(`class_${index}`, `××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª ×‘×”×Ÿ ×¢××“×• ×™×œ×“×™ ×›×™×ª×” "${className}"`, classData, true);
                milestonesDashboard.appendChild(classSection);
            });

            const mainButtons = document.createElement('div');
            mainButtons.className = 'section';
            mainButtons.innerHTML = `
                <div class="buttons-row">
                    <button class="btn btn-pdf" onclick="milestonesSavePDF()">ğŸ“„ ×©××•×¨ ×”×›×œ ×›-PDF</button>
                    <button class="btn btn-reset" onclick="milestonesReset()">ğŸ”„ ×”×¢×œ×” ×§×•×‘×¥ ×—×“×©</button>
                </div>
            `;
            milestonesDashboard.appendChild(mainButtons);

            milestonesDashboard.classList.add('active');

            setTimeout(() => {
                Object.keys(milestonesSectionsData).forEach(key => {
                    milestonesCreateChart(key, milestonesSectionsData[key]);
                });
            }, 100);
        }

        function milestonesCreateSection(id, title, data, isClass = false) {
            const stats = milestonesGetStats(data);
            const percentages = milestonesCalculatePercentages(data);
            milestonesSectionsData[id] = { data, stats, percentages, title };

            const section = document.createElement('div');
            section.className = `section ${isClass ? 'class-section' : ''}`;
            section.id = `section_${id}`;

            const order = ['×—×‘×¨×”', '×©×¤×”', '××•×˜×•×¨×™×§×” ×’×¡×”', '××•×˜×•×¨×™×§×” ×¢×“×™× ×”'];

            const rowsHtml = order.map(name => {
                const p = percentages[name] || { percentage: 0, count: 0, total: stats.total || 0 };
                const barClass = colorClasses[name] || '';
                const percentStyle = `width: ${isFinite(p.percentage) ? p.percentage : 0}%`;
                return `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td>
                            <div class="percentage-bar">
                                <div class="bar-container">
                                    <div class="bar-fill ${barClass}" style="${percentStyle}"></div>
                                </div>
                                <span>${(isFinite(p.percentage) ? p.percentage.toFixed(1) : '0.0')}%</span>
                            </div>
                        </td>
                        <td>${p.count} / ${p.total}</td>
                    </tr>
                `;
            }).join('');

            section.innerHTML = `
                <h2 class="section-title">${title}</h2>
                
                <div class="stats-row">
                    <span class="stat-badge total">×¡×”"×›: ${stats.total}</span>
                    <span class="stat-badge boys">ğŸ‘¦ ×‘× ×™×: ${stats.boys}</span>
                    <span class="stat-badge girls">ğŸ‘§ ×‘× ×•×ª: ${stats.girls}</span>
                    <span class="stat-badge age">ğŸ“… ×’×™×œ××™×: ${stats.minAge.toFixed(1)} - ${stats.maxAge.toFixed(1)}</span>
                </div>

                <div class="chart-container">
                    <canvas id="chart_${id}"></canvas>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>×§×˜×’×•×¨×™×”</th>
                            <th>××—×•×– ×¢××™×“×”</th>
                            <th>×›××•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHtml}
                    </tbody>
                </table>

                <div class="buttons-row">
                    <button class="btn btn-save" onclick="milestonesSaveSection('${id}')">ğŸ“· ×©××•×¨ ×›×ª××•× ×”</button>
                </div>
            `;

            return section;
        }

        function milestonesCreateChart(id, sectionData) {
            const canvasEl = document.getElementById(`chart_${id}`);
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');
            const order = ['×—×‘×¨×”', '×©×¤×”', '××•×˜×•×¨×™×§×” ×’×¡×”', '××•×˜×•×¨×™×§×” ×¢×“×™× ×”'];
            const percentages = sectionData.percentages;

            const dataValues = order.map(name => {
                const p = percentages[name];
                return (p && isFinite(p.percentage)) ? p.percentage : 0;
            });

            const bg = order.map(name => milestonesColors[name] ? milestonesColors[name].bg : 'rgba(0,0,0,0.1)');
            const border = order.map(name => milestonesColors[name] ? milestonesColors[name].border : '#ccc');

            if (milestonesCharts[id]) {
                try { milestonesCharts[id].destroy(); } catch (_) {}
            }

            milestonesCharts[id] = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: order,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: bg,
                        borderColor: border,
                        borderWidth: 3,
                        borderRadius: 8,
                        barThickness: 60
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#333',
                            font: { size: 13, weight: 'bold', family: 'Heebo' },
                            formatter: (value) => {
                                if (!isFinite(value)) return '0.0%';
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: (v) => v + '%', font: { size: 11, family: 'Heebo' } },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            ticks: { font: { size: 12, family: 'Heebo', weight: '600' } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function milestonesSaveSection(id) {
            const sectionData = milestonesSectionsData[id];
            if (!sectionData) return;
            const canvas = document.getElementById(`chart_${id}`);
            if (!canvas) return;
            
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            const width = 900;
            const chartHeight = 350;
            const tableHeight = 220;
            const padding = 40;
            
            tempCanvas.width = width;
            tempCanvas.height = chartHeight + tableHeight + padding * 3 + 40;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 22px Heebo, Arial';
            ctx.textAlign = 'center';
            ctx.fillText(sectionData.title, width / 2, padding + 18);
            
            const stats = sectionData.stats;
            ctx.font = '14px Heebo, Arial';
            ctx.fillStyle = '#4b5563';
            ctx.fillText(`×¡×”"×›: ${stats.total}  |  ×‘× ×™×: ${stats.boys}  |  ×‘× ×•×ª: ${stats.girls}  |  ×’×™×œ××™×: ${stats.minAge.toFixed(1)} - ${stats.maxAge.toFixed(1)}`, width / 2, padding + 45);
            
            try {
                const chartImg = canvas.toDataURL('image/png');
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, (width - 800) / 2, padding + 60, 800, chartHeight - 60);
                    milestonesDrawTable(ctx, sectionData.percentages, padding, chartHeight + padding + 60, width - padding * 2);
                    const link = document.createElement('a');
                    const safeName = sectionData.title.replace(/[^×-×ªa-zA-Z0-9]/g, '_');
                    link.download = `${safeName}.png`;
                    link.href = tempCanvas.toDataURL('image/png', 1.0);
                    link.click();
                };
                img.src = chartImg;
            } catch (err) {
                alert('×©×’×™××” ×‘×™×¦×•× ×”×ª××•× ×”');
            }
        }

        function milestonesDrawTable(ctx, percentages, x, y, width) {
            const order = ['×—×‘×¨×”', '×©×¤×”', '××•×˜×•×¨×™×§×” ×’×¡×”', '××•×˜×•×¨×™×§×” ×¢×“×™× ×”'];
            const rowHeight = 40;
            const headerHeight = 40;
            
            const barColors = {
                '×—×‘×¨×”': '#c4b5fd',
                '×©×¤×”': '#fdba74',
                '××•×˜×•×¨×™×§×” ×’×¡×”': '#7dd3fc',
                '××•×˜×•×¨×™×§×” ×¢×“×™× ×”': '#86efac'
            };
            
            ctx.fillStyle = '#667eea';
            ctx.fillRect(x, y, width, headerHeight);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Heebo, Arial';
            ctx.textAlign = 'right';
            ctx.fillText('×§×˜×’×•×¨×™×”', x + 150, y + 26);
            ctx.fillText('××—×•×– ×¢××™×“×”', x + width / 2 + 50, y + 26);
            ctx.fillText('×›××•×ª', x + width - 30, y + 26);
            
            order.forEach((name, i) => {
                const rowY = y + headerHeight + (i * rowHeight);
                const data = percentages[name] || { percentage: 0, count: 0, total: 0 };
                
                ctx.fillStyle = i % 2 === 0 ? '#f9fafb' : 'white';
                ctx.fillRect(x, rowY, width, rowHeight);
                
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, rowY + rowHeight);
                ctx.lineTo(x + width, rowY + rowHeight);
                ctx.stroke();
                
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 13px Heebo, Arial';
                ctx.textAlign = 'right';
                ctx.fillText(name, x + 150, rowY + 26);
                
                const barX = x + 180;
                const barWidth = 200;
                ctx.fillStyle = '#e5e7eb';
                ctx.fillRect(barX, rowY + 14, barWidth, 12);
                ctx.fillStyle = barColors[name] || '#cbd5e1';
                const w = (isFinite(data.percentage) ? (data.percentage / 100) * barWidth : 0);
                ctx.fillRect(barX, rowY + 14, w, 12);
                
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 13px Heebo, Arial';
                ctx.textAlign = 'left';
                ctx.fillText((isFinite(data.percentage) ? data.percentage.toFixed(1) : '0.0') + '%', barX + barWidth + 15, rowY + 26);
                
                ctx.textAlign = 'right';
                ctx.font = '13px Heebo, Arial';
                ctx.fillText(`${data.count} / ${data.total}`, x + width - 30, rowY + 26);
            });
            
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, headerHeight + order.length * rowHeight);
        }
        

        async function milestonesSavePDF() {
            if (!jsPDF) {
                alert('×©××™×¨×” ×›-PDF ×œ× ×–××™× ×”');
                return;
            }
        
            // ×•×“××™ ×©×”×’×¨×¤×™× "×¡×™×™××•" ×œ×¦×™×™×¨ ×œ×¤× ×™ ×¦×™×œ×•×
            try {
                Object.values(milestonesCharts).forEach(ch => {
                    if (ch && typeof ch.update === 'function') ch.update('none');
                });
            } catch (_) {}
        
            // ××•×¡×¤×™× ××ª ×›×œ ×”×¡×§×©× ×™× ×©×œ ××‘× ×™ ×“×¨×š (×›×•×œ×œ ×›×œ ×›×™×ª×” + ×›×œ×œ×™)
            // ××‘×œ ×œ× ××ª ×¡×§×©×Ÿ ×”×›×¤×ª×•×¨×™× ×‘×¡×•×£
            const sections = Array.from(milestonesDashboard.querySelectorAll('.section'))
                .filter(sec => !sec.querySelector('.btn-pdf')); // ××¡× ×Ÿ ××ª ×”×¡×§×©×Ÿ ×©×™×© ×‘×• "×©××•×¨ ×”×›×œ ×›-PDF"
        
            if (sections.length === 0) {
                alert('××™×Ÿ ×¡×§×©× ×™× ×œ×™×™×¦×•×');
                return;
            }
        
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pageW = pdf.internal.pageSize.getWidth();
            const pageH = pdf.internal.pageSize.getHeight();
        
            const margin = 10;
            const gap = 8; // ×¨×•×•×— ×‘×™×Ÿ ×©× ×™ ×¡×§×©× ×™× ×‘××•×ª×• ×¢××•×“
        
            // ×’×•×‘×” ××§×¡×™××œ×™ ×œ×›×œ "×—×¦×™ ×¢××•×“" (2 ×›×™×ª×•×ª ×‘×“×£)
            const halfMaxH = (pageH - margin * 2 - gap) / 2;
        
            // ×›×“×™ ×©×–×” ×™×™×¨××” ×›××• ×‘××ª×¨: ××¦×œ××™× HTML ×¢× html2canvas
            
            for (let i = 0; i < sections.length; i++) {
                const sec = sections[i];
            
                // ××¡×ª×™×¨×™× ××ª ×›×¤×ª×•×¨ "×©××•×¨ ×›×ª××•× ×”" ×‘×ª×•×š ×”×¡×§×©×Ÿ ×›×“×™ ×©×œ× ×™×•×¤×™×¢ ×‘-PDF
                const buttonsRow = sec.querySelector('.buttons-row');
                const prevDisplay = buttonsRow ? buttonsRow.style.display : null;
                if (buttonsRow) buttonsRow.style.display = 'none';
            
                // × ×•×ª× ×™× ×¨×’×¢ ×§×˜×Ÿ ×œ×“×¤×“×¤×Ÿ ×œ×¢×“×›×Ÿ ×¨×™× ×“×•×¨ ×œ×¤× ×™ ×¦×™×œ×•×
                await new Promise(r => setTimeout(r, 60));
            
                let canvas;
                try {
                    canvas = await html2canvas(sec, {
                        scale: 2.5,
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        allowTaint: false
                    });
                } catch (err) {
                    if (buttonsRow) buttonsRow.style.display = prevDisplay || '';
                    alert('×©×’×™××” ×‘×¦×™×œ×•× ×”×¡×§×©×Ÿ ×œ-PDF: ' + err.message);
                    return;
                }
            
                // ××—×–×™×¨×™× ×›×¤×ª×•×¨×™×
                if (buttonsRow) buttonsRow.style.display = prevDisplay || '';
            
                // ×›×œ 2 ×¡×§×©× ×™×â€”×“×£ ×—×“×© (××œ×‘×“ ×”×¨××©×•×Ÿ)
                if (i > 0 && i % 2 === 0) pdf.addPage();
            
                // ×—×™×©×•×‘ ×”×ª×××ª ×’×•×“×œ ×œ×ª×•×š ×—×¦×™ ×¢××•×“
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
            
                let imgW = pageW - margin * 2;
                let imgH = (canvas.height * imgW) / canvas.width;
            
                // ×× ×”×ª××•× ×” ×’×‘×•×”×” ××“×™ ×œ×—×¦×™ ×¢××•×“â€”××§×˜×™× ×™× ×¤×¨×•×¤×•×¨×¦×™×•× ×œ×™×ª
                if (imgH > halfMaxH) {
                    const scale = halfMaxH / imgH;
                    imgW = imgW * scale;
                    imgH = halfMaxH;
                }
            
                const x = (pageW - imgW) / 2;
                const y = margin + (i % 2) * (halfMaxH + gap);
            
                pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH);
            
                // ===== ×ª××¨×™×š ××”×§×•×‘×¥ (×¤×™× ×” ×©×××œ×™×ª ×¢×œ×™×•× ×”) =====
                if (milestonesReportDate) {
                    pdf.setFontSize(9);
                    pdf.setTextColor(120);
                    pdf.text(String(milestonesReportDate), 8, 8);
                }
            } // âœ… ×¡×•×’×¨ ×©×œ ×”-for
            
            pdf.save(`×“×•×—_××¢×•×Ÿ_${milestonesOrgName}.pdf`);
            } // âœ… ×¡×•×’×¨ ×©×œ ×”×¤×•× ×§×¦×™×” milestonesSavePDF

        function milestonesReset() {
            milestonesDashboard.classList.remove('active');
            milestonesDashboard.innerHTML = '';
            milestonesUploadCard.style.display = 'block';
            milestonesFileInput.value = '';
            milestonesCharts = {};
            milestonesSectionsData = {};
            milestonesAllData = null;
        }

        // ============ SUBJECTIVE APP ============
        const subjectiveUploadArea = document.getElementById('subjectiveUploadArea');
        const subjectiveFileInput = document.getElementById('subjectiveFileInput');
        const subjectiveUploadCard = document.getElementById('subjectiveUploadCard');
        const subjectiveLoading = document.getElementById('subjectiveLoading');
        const subjectiveDashboard = document.getElementById('subjectiveDashboard');
        const subjectiveGlobalLegend = document.getElementById('subjectiveGlobalLegend');

        const BEHAVIOR_COLUMNS = {
            'behavior_q1_×¤×—×“': '×¤×—×“',
            'behavior_q2_××›×™×œ×”': '××›×™×œ×”',
            'behavior_q2_××œ×™××•×ª': '××œ×™××•×ª',
            'behavior_q2_×‘×›×™ ×××•×©×š': '×‘×›×™ ×××•×©×š',
            'behavior_q2_×”×ª×¤×¨×¦×•×™×•×ª': '×”×ª×¤×¨×¦×•×™×•×ª',
            'behavior_q2_×©×™× ×”': '×©×™× ×”'
        };

        const SUBJECTIVE_COLORS = {
            3: '#FFF3B0',
            4: '#FFD6A5',
            5: '#FFADAD',
            other: '#DCFCE7'
        };

        const SUBJECTIVE_TITLES = {
          "××œ×™××•×ª": {
            title: "×”×ª× ×”×’×•×ª ××œ×™××”",
            subtitle: "×“×™×•×•×—×™× ×¢×œ ×”×‘×¢×ª ×”×ª× ×”×’×•×ª ××œ×™××” ×‘×§×¨×‘ ×™×œ×“×™ ×”×›×™×ª×”"
          },
          "××›×™×œ×”": {
            title: "××›×™×œ×”",
            subtitle: "×”×§×©×™×™× ×©×“×•×•×—×• ×‘×ª×—×•× ×”××›×™×œ×” ×‘×§×¨×‘ ×™×œ×“×™ ×”×›×™×ª×”"
          },
          "×©×™× ×”": {
            title: "×©×™× ×”",
            subtitle: "×”×§×©×™×™× ×©×“×•×•×—×• ×‘×ª×—×•× ×”×©×™× ×” ×‘×§×¨×‘ ×™×œ×“×™ ×”×›×™×ª×”"
          },
          "×¤×—×“": {
            title: "×¤×—×“",
            subtitle: "×”×§×©×™×™× ×©×“×•×•×—×• ×¡×‘×™×‘ ×‘×™×˜×•×™×™ ×¤×—×“ ×‘×§×¨×‘ ×™×œ×“×™ ×”×›×™×ª×”"
          },
          "×”×ª×¤×¨×¦×•×™×•×ª": {
            title: "×”×ª×¤×¨×¦×•×™×•×ª",
            subtitle: "×”×§×©×™×™× ×©×“×•×•×—×• ×¡×‘×™×‘ ×”×ª×¤×¨×¦×•×™×•×ª ×‘×§×¨×‘ ×™×œ×“×™ ×”×›×™×ª×”"
          },
          "×‘×›×™ ×××•×©×š": {
            title: "×‘×›×™",
            subtitle: "×”×§×©×™×™× ×©×“×•×•×—×• ×¡×‘×™×‘ ×‘×›×™ ×‘×§×¨×‘ ×™×œ×“×™ ×”×›×™×ª×”"
          }
        };



        let subjectiveProcessedData = null;
        let subjectiveGroupElements = [];
        let subjectiveOrgName = '';
        let subjectiveReportDate = '';



        subjectiveUploadArea.addEventListener('click', () => subjectiveFileInput.click());
        subjectiveUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); subjectiveUploadArea.style.borderColor = '#059669'; });
        subjectiveUploadArea.addEventListener('dragleave', () => subjectiveUploadArea.style.borderColor = '#10b981');
        subjectiveUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            subjectiveUploadArea.style.borderColor = '#10b981';
            if (e.dataTransfer.files[0]) subjectiveProcessFile(e.dataTransfer.files[0]);
        });
        subjectiveFileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) subjectiveProcessFile(e.target.files[0]);
        });

        function subjectiveProcessFile(file) {
            subjectiveUploadCard.style.display = 'none';
            subjectiveLoading.classList.add('active');
            subjectiveGroupElements = [];

            const reader = new FileReader();
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.onload = (e) => {
                    Papa.parse(e.target.result, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => subjectiveAnalyzeData(results.data)
                    });
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        subjectiveAnalyzeData(jsonData);
                    } catch (err) {
                        alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”-Excel');
                        subjectiveLoading.classList.remove('active');
                        subjectiveUploadCard.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function subjectiveAnalyzeData(data) {
            subjectiveLoading.classList.remove('active');
            

            if (!data || data.length === 0) {
                alert('×œ× × ××¦××• × ×ª×•× ×™× ×‘×§×•×‘×¥');
                subjectiveUploadCard.style.display = 'block';
                return;
            }
            // ===== ×©××™×¨×ª ×ª××¨×™×š ×¨××©×•×Ÿ ××”×§×•×‘×¥ =====
            if (data.length > 0 && data[0]['Date']) {
                subjectiveReportDate = String(data[0]['Date']).trim();
            } else {
                subjectiveReportDate = '';
            }

            subjectiveOrgName =
              (data[0] && data[0].org_name)
                ? String(data[0].org_name).trim()
                : '';
            
            const titleEl = document.getElementById('subjectiveTitleMain');
            if (titleEl) {
              titleEl.textContent = subjectiveOrgName
                ? `× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™ â€“ ${subjectiveOrgName}`
                : '× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™';
            }

            const headers = Object.keys(data[0]);
            const required = ['clinic_name', 'behavior_main'];
            const missing = required.filter(col => !headers.includes(col));
            
            if (missing.length > 0) {
                alert(`×¢××•×“×•×ª ×—×¡×¨×•×ª: ${missing.join(', ')}`);
                subjectiveUploadCard.style.display = 'block';
                return;
            }

            const availableBehaviorCols = Object.keys(BEHAVIOR_COLUMNS).filter(col => headers.includes(col));
            
            if (availableBehaviorCols.length === 0) {
                alert('×œ× × ××¦××• ×¢××•×“×•×ª ×”×ª× ×”×’×•×ª ×œ× ×™×ª×•×—');
                subjectiveUploadCard.style.display = 'block';
                return;
            }
            

            const groups = {};
            data.forEach(row => {
                const clinicName = row.clinic_name || '×œ× ××•×’×“×¨';
                if (!groups[clinicName]) groups[clinicName] = [];
                groups[clinicName].push(row);
            });

            subjectiveProcessedData = { groups, availableBehaviorCols };
            subjectiveGlobalLegend.style.display = 'block';
            subjectiveBuildDashboard(groups, availableBehaviorCols);



        }

        function subjectiveBuildDashboard(groups, behaviorCols) {
            subjectiveDashboard.innerHTML = '';
            subjectiveGroupElements = [];

            Object.keys(groups).sort().forEach(groupName => {
                const groupData = groups[groupName];
                subjectiveRenderGroup(groupName, groupData, behaviorCols);
            });

            const mainButtons = document.createElement('div');
            mainButtons.className = 'section';
            mainButtons.innerHTML = `
                <div class="buttons-row">
                    <button class="btn btn-pdf" onclick="subjectiveExportPDF()">ğŸ“„ ×™×™×¦×•× PDF </button>
                    <button class="btn btn-excel" onclick="subjectiveExportExcel()">ğŸ“Š ×™×™×¦×•× Excel</button>
                    <button class="btn btn-reset" onclick="subjectiveReset()">ğŸ”„ ×”×¢×œ×” ×§×•×‘×¥ ×—×“×©</button>
                </div>
            `;
            subjectiveDashboard.appendChild(mainButtons);

            subjectiveDashboard.classList.add('active');
        }

        function subjectiveRenderGroup(groupName, groupData, behaviorCols) {
            const filtered = groupData.filter(row => {
              const v = Number(row.behavior_main);
              return v === 2 || v === 0;
            });

            const section = document.createElement('div');
            section.className = 'group-section';
            section.id = 'subj-group-' + groupName.replace(/\s+/g, '-').replace(/[^\w\u0590-\u05FF-]/g, '');

            subjectiveGroupElements.push({ name: groupName, element: section });

            const header = document.createElement('div');
            header.className = 'group-header';

            const titleContainer = document.createElement('div');
            const title = document.createElement('h2');
            title.className = 'group-title';
            title.textContent = `ğŸ« ${groupName}`;
            titleContainer.appendChild(title);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'group-actions';
            const exportBtn = document.createElement('button');
            exportBtn.className = 'group-export-btn';
            exportBtn.innerHTML = 'ğŸ“· ×™×™×¦×•× ×ª××•× ×”';
            exportBtn.onclick = () => subjectiveExportGroupImage(groupName);
            actionsDiv.appendChild(exportBtn);
            titleContainer.appendChild(actionsDiv);

            header.appendChild(titleContainer);

            const stats = document.createElement('div');
            stats.className = 'group-stats';
            stats.innerHTML = `
              <div class="stat-box">
                <div class="stat-value">${groupData.length}</div>
                <div class="stat-label">×¡×”×´×› ×™×œ×“×™× ×‘×›×™×ª×”</div>
              </div>
            `;
            header.appendChild(stats);
            section.appendChild(header);

            if (filtered.length === 0) {
                const noData = document.createElement('div');
                noData.className = 'no-data';
                noData.textContent = 'ğŸ¤© ××™×Ÿ ×§×•×©×™ ××“×•×•×— ×‘×›×™×ª×” ×–×•';
                section.appendChild(noData);
                subjectiveDashboard.appendChild(section);
                return;
            }

            
            const grid = document.createElement('div');
            grid.className = 'charts-grid';
            
            const totalN = groupData.length; // ×¡×”"×› ×ª×¦×¤×™×•×ª ×‘×›×™×ª×” (×¤×¢× ××—×ª ×‘×œ×‘×“)
            
            behaviorCols.forEach(col => {
                const chartCard = subjectiveCreateChartCard(col, filtered, totalN);
                grid.appendChild(chartCard);
            });
            
            section.appendChild(grid);
            
            
            subjectiveDashboard.appendChild(section);


        }

        function subjectiveCreateChartCard(column, data, totalN) {
            const N = data.length;
            let count3 = 0, count4 = 0, count5 = 0;

            data.forEach(row => {
                const val = parseFloat(row[column]);
                if (val === 3) count3++;
                else if (val === 4) count4++;
                else if (val === 5) count5++;
            });

            const countOther =  Math.max(0, totalN - (count3 + count4 + count5));
            const hasAnyDifficulty = (count3 + count4 + count5) > 0;

            const card = document.createElement('div');
            card.className = 'chart-card';

            const headerWrapper = document.createElement('div');
            headerWrapper.className = 'chart-header';
            
            const shortLabel = BEHAVIOR_COLUMNS[column];
            const titleData = SUBJECTIVE_TITLES[shortLabel];
            
            // ×›×•×ª×¨×ª ×¨××©×™×ª
            const title = document.createElement('div');
            title.className = 'chart-title-main';
            title.textContent = titleData ? titleData.title : shortLabel;
            
            // ×›×•×ª×¨×ª ××©× ×™×ª
            const subtitle = document.createElement('div');
            subtitle.className = 'chart-title-sub';
            subtitle.textContent = titleData ? titleData.subtitle : '';
            
            headerWrapper.appendChild(title);
            headerWrapper.appendChild(subtitle);
            card.appendChild(headerWrapper);


            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            
            if (!hasAnyDifficulty) {
                const msg = document.createElement('div');
                msg.className = 'no-difficulty-msg';
                msg.textContent = '××™×Ÿ ×§×•×©×™ ××“×•×•×— ğŸ˜Š';
                wrapper.appendChild(msg);
            } else {
                const canvas = document.createElement('canvas');
                canvas.className = 'pie-chart';
                canvas.width = 180;
                canvas.height = 180;
                wrapper.appendChild(canvas);
            
                subjectiveDrawPieChart(canvas, count3, count4, count5, countOther, totalN);
            }
            
            card.appendChild(wrapper);


            const DEN = Number(totalN) || 0;  // ×¡×”"×› ×ª×¦×¤×™×•×ª ×‘×›×™×ª×”

            const pct3 = DEN > 0 ? ((count3 / DEN) * 100).toFixed(1) : '0.0';
            const pct4 = DEN > 0 ? ((count4 / DEN) * 100).toFixed(1) : '0.0';
            const pct5 = DEN > 0 ? ((count5 / DEN) * 100).toFixed(1) : '0.0';
            const pctOther = DEN > 0 ? ((countOther / DEN) * 100).toFixed(1) : '0.0';

            if (hasAnyDifficulty) {
                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `
                  <thead><tr><th>×¨××ª ×§×•×©×™</th><th>××¡×¤×¨</th><th>××—×•×–</th></tr></thead>
                  <tbody>
                    <tr><td><span class="color-indicator" style="background: ${SUBJECTIVE_COLORS[3]};"></span>×§×•×©×™ ×§×œ</td><td>${count3}</td><td>${pct3}%</td></tr>
                    <tr><td><span class="color-indicator" style="background: ${SUBJECTIVE_COLORS[4]};"></span>×§×•×©×™ ×‘×™× ×•× ×™</td><td>${count4}</td><td>${pct4}%</td></tr>
                    <tr><td><span class="color-indicator" style="background: ${SUBJECTIVE_COLORS[5]};"></span>×§×•×©×™ ×¨×‘</td><td>${count5}</td><td>${pct5}%</td></tr>
                    <tr><td><span class="color-indicator" style="background: ${SUBJECTIVE_COLORS.other}; border: 1px solid #22c55e;"></span>××™×Ÿ ×§×•×©×™ ××“×•×•×— ğŸ˜Š</td><td>${countOther}</td><td>${pctOther}%</td></tr>
                  </tbody>
                `;
                card.appendChild(table);
            }
            return card;
            }

        function subjectiveCreateRegressionSection(data, totalN) {
            const section = document.createElement('div');
            section.className = 'regression-section';

            let zeroCount = 0;
            data.forEach(row => {
                const val = row['behavior_× ×¡×™×’×”'];
                if (val === '0' || val === 0 || parseFloat(val) === 0) zeroCount++;
            });

            const DEN = Number(totalN) || 0;
            const pct = DEN > 0 ? ((zeroCount / DEN) * 100).toFixed(1) : '0.0';

            section.innerHTML = `
                <div class="regression-title">ğŸ“‰ × ×™×ª×•×— × ×¡×™×’×” (behavior_× ×¡×™×’×”)</div>
                <div class="regression-content">
                    <div class="regression-stat">
                        <div class="regression-value">${zeroCount}</div>
                        <div class="regression-label">
                            ${zeroCount} ×™×œ×“×™× ×¢× × ×¡×™×’×”<br>
                            (${pct}% ××ª×•×š ×›×œ×œ ×”×›×™×ª×”)
                    </div>
                    <div class="regression-stat">
                        <div class="regression-value">${pct}%</div>
                        <div class="regression-label">××ª×•×š ${totalN} ×™×œ×“×™× ×‘×›×™×ª×”</div>
                    </div>
                </div>
            `;

            return section;
        }

        function subjectiveDrawPieChart(canvas, count3, count4, count5, countOther, total) {
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (total === 0) {
                ctx.fillStyle = '#eee';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();
                return;
            }

            const slices = [
                { value: count3, color: SUBJECTIVE_COLORS[3] },
                { value: count4, color: SUBJECTIVE_COLORS[4] },
                { value: count5, color: SUBJECTIVE_COLORS[5] },
                { value: countOther, color: SUBJECTIVE_COLORS.other }
            ];

            let startAngle = -Math.PI / 2;

            slices.forEach(slice => {
                if (slice.value === 0) return;

                const sliceAngle = (slice.value / total) * Math.PI * 2;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = slice.color;
                ctx.fill();
                ctx.strokeStyle = slice.color === SUBJECTIVE_COLORS.other ? '#CCCCCC' : '#fff';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                if (slice.value / total > 0.05) {
                    const midAngle = startAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(midAngle) * radius * 0.65;
                    const labelY = centerY + Math.sin(midAngle) * radius * 0.65;
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 11px Heebo, Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(((slice.value / total) * 100).toFixed(0) + '%', labelX, labelY);
                }

                startAngle += sliceAngle;
            });

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        async function subjectiveExportGroupImage(groupName) {
            const modal = document.getElementById('exportModal');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            document.getElementById('modalTitle').textContent = '××™×™×¦× ×ª××•× ×”...';
            modal.style.display = 'flex';
            progressFill.style.width = '20%';
            progressText.textContent = '××›×™×Ÿ ××ª ×”×ª××•× ×”...';

            const groupId = 'subj-group-' + groupName.replace(/\s+/g, '-').replace(/[^\w\u0590-\u05FF-]/g, '');
            const groupElement = document.getElementById(groupId);
            
            if (!groupElement) {
                alert('×œ× × ××¦×');
                modal.style.display = 'none';
                return;
            }

            const exportBtns = groupElement.querySelectorAll('.group-export-btn');
            exportBtns.forEach(btn => btn.style.display = 'none');

            try {
                progressFill.style.width = '50%';
                const capturedCanvas = await html2canvas(groupElement, {
                    scale: 3,
                    backgroundColor: '#ffffff'
                });
                
                // ×™×¦×™×¨×ª ×§× ×‘×¡ ×—×“×© ×¢× ×›×•×ª×¨×ª
                const titleHeight = 80;
                const outCanvas = document.createElement('canvas');
                outCanvas.width = capturedCanvas.width;
                outCanvas.height = capturedCanvas.height + titleHeight;
                
                const ctx = outCanvas.getContext('2d');
                
                // ×¨×§×¢ ×œ×‘×Ÿ
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, outCanvas.width, outCanvas.height);
                
                // ×›×•×ª×¨×ª
                ctx.fillStyle = '#166534';
                ctx.font = 'bold 28px Heebo, Arial';
                ctx.textAlign = 'center';
                ctx.fillText(
                  subjectiveOrgName
                    ? `× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™ â€“ ${subjectiveOrgName}`
                    : '× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™',
                  outCanvas.width / 2,
                  45
                );
                
                // ×”×“×‘×§×ª ×”×ª×•×›×Ÿ ×”××¦×•×œ× ××ª×—×ª ×œ×›×•×ª×¨×ª
                ctx.drawImage(capturedCanvas, 0, titleHeight);

                progressFill.style.width = '90%';
                
                outCanvas.toBlob((blob) => {
                    const link = document.createElement('a');
                    const orgPart = subjectiveOrgName ? `_${subjectiveOrgName}` : '';
                    link.download = `×›×™×ª×”_${groupName}${orgPart}_× ×™×ª×•×—_×©××œ×•×Ÿ_×¡×•×‘×™×™×§×˜×™×‘×™.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                
                    progressFill.style.width = '100%';
                    progressText.textContent = '×”×•×©×œ×!';
                    setTimeout(() => { modal.style.display = 'none'; }, 500);
                }, 'image/png', 1.0);

            } catch (err) {
                alert('×©×’×™××”: ' + err.message);
                modal.style.display = 'none';
            }

            exportBtns.forEach(btn => btn.style.display = 'flex');
        }

        function trimCanvasWhitespace(canvas, threshold = 250, pad = 8) {
          const ctx = canvas.getContext('2d');
          const { width, height } = canvas;
          const img = ctx.getImageData(0, 0, width, height);
          const data = img.data;
        
          let top = null, left = null, right = null, bottom = null;
        
          const isWhite = (r,g,b,a) => {
            if (a === 0) return true;
            return r >= threshold && g >= threshold && b >= threshold;
          };
        
          for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
              const i = (y * width + x) * 4;
              const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
              if (!isWhite(r,g,b,a)) {
                if (top === null) top = y;
                if (left === null || x < left) left = x;
                if (right === null || x > right) right = x;
                bottom = y;
              }
            }
          }
        
          if (top === null) return canvas;
        
          left = Math.max(0, left - pad);
          top = Math.max(0, top - pad);
          right = Math.min(width - 1, right + pad);
          bottom = Math.min(height - 1, bottom + pad);
        
          const w = right - left + 1;
          const h = bottom - top + 1;
        
          const out = document.createElement('canvas');
          out.width = w;
          out.height = h;
          out.getContext('2d').drawImage(canvas, left, top, w, h, 0, 0, w, h);
          return out;
        }

        async function subjectiveExportPDF() {
            if (subjectiveGroupElements.length === 0) return;

            const modal = document.getElementById('exportModal');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressDetail = document.getElementById('progressDetail');
            
            document.getElementById('modalTitle').textContent = 'ğŸ“„ ××™×™×¦× PDF...';
            modal.style.display = 'flex';
            progressFill.style.width = '5%';

            try {
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                for (let i = 0; i < subjectiveGroupElements.length; i++) {
                    
                    const group = subjectiveGroupElements[i];

                    if (i > 0) pdf.addPage();
                    
                    progressFill.style.width = `${((i + 1) / subjectiveGroupElements.length) * 90}%`;
                    progressText.textContent = `××¢×‘×“: ${group.name}`;
                    progressDetail.textContent = `${i + 1} / ${subjectiveGroupElements.length}`;

                    const exportBtns = group.element.querySelectorAll('.group-export-btn');
                    exportBtns.forEach(btn => btn.style.display = 'none');

                    await new Promise(r => setTimeout(r, 50));
                    const canvas = await html2canvas(group.element, { scale: 2.5, backgroundColor: null });
                    exportBtns.forEach(btn => btn.style.display = 'flex');
                    
                    // âœ‚ï¸ ×—×™×ª×•×š ×©×•×œ×™×™× ×œ×‘× ×™×
                    const trimmed = trimCanvasWhitespace(canvas, 250, 8);
                    const imgData = trimmed.toDataURL('image/jpeg', 0.95);
                    
                    // ×’×‘×•×œ×•×ª ×¢××•×“ (××©××™×¨×™× ××§×•× ×œ×œ×•×’×•××™× ×œ××˜×”)
                    const margin = 10;
                    const footerReserve = 22; // ×›×“×™ ×©×”×œ×•×’×•××™× ×œ× "×™××›×œ×•" ××ª ×”×ª×•×›×Ÿ
                    const maxWidth  = pageWidth - margin * 2;
                    const maxHeight = pageHeight - margin * 2 - footerReserve;
                    
                    // ×”×ª×××” ×¤×¨×•×¤×•×¨×¦×™×•× ×œ×™×ª (×‘×œ×™ ×“×—×™×¡×”)
                    let imgWidth  = maxWidth;
                    let imgHeight = (trimmed.height * imgWidth) / trimmed.width;
                    
                    if (imgHeight > maxHeight) {
                      imgHeight = maxHeight;
                      imgWidth  = (trimmed.width * imgHeight) / trimmed.height;
                    }
                    
                    // ××¨×›×– ×’× ××•×¤×§×™ ×•×’× ×× ×›×™ ×‘×ª×•×š ×”××–×•×¨ (×›×•×œ×œ ××—×¨×™ trim)
                    const x = (pageWidth - imgWidth) / 2;
                    const titleOffset = (i === 0) ? 8 : 0;
                    const y = margin + titleOffset + (maxHeight - imgHeight) / 2;

                    
                    if (i === 0) {
                    // ×›×•×ª×¨×ª + ×©× ××¢×•×Ÿ ×‘×¨××© ×”×¢××•×“
                    // ===== ×›×•×ª×¨×ª ×›-IMAGE (×¢×‘×¨×™×ª ×ª×§×™× ×”) =====
                    const titleCanvas = document.createElement('canvas');
                    const titleCtx = titleCanvas.getContext('2d');
                    
                    titleCanvas.width = 1200;
                    titleCanvas.height = 80;
                    
                    titleCtx.fillStyle = '#ffffff';
                    titleCtx.fillRect(0, 0, titleCanvas.width, titleCanvas.height);
                    
                    titleCtx.fillStyle = '#166534';
                    titleCtx.font = 'bold 36px Heebo, Arial';
                    titleCtx.textAlign = 'center';
                    titleCtx.textBaseline = 'middle';
                    
                    const titleText = subjectiveOrgName
                      ? `× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™ â€“ ${subjectiveOrgName}`
                      : '× ×™×ª×•×— ×©××œ×•×Ÿ ×¡×•×‘×™×™×§×˜×™×‘×™';
                    
                    titleCtx.fillText(titleText, titleCanvas.width / 2, titleCanvas.height / 2);
                    
                    const titleImg = titleCanvas.toDataURL('image/png');
                    
                    // ×¦×™×•×¨ ×”×›×•×ª×¨×ª ×‘-PDF
                    const titleImgWidth = pageWidth - 20;
                    const titleImgHeight = (titleCanvas.height * titleImgWidth) / titleCanvas.width;
                    
                    pdf.addImage(titleImg, 'PNG', 10, 8, titleImgWidth, titleImgHeight);
                    }

                    pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
                    // ===== ×ª××¨×™×š ×‘×¤×™× ×” ×©×××œ×™×ª ×¢×œ×™×•× ×” =====
                    // ===== ×ª××¨×™×š ××”×§×•×‘×¥ =====
                    if (subjectiveReportDate) {
                        pdf.setFontSize(9);
                        pdf.setTextColor(120);
                        pdf.text(subjectiveReportDate, 8, 8);
                    }


                    
                    // ×œ×•×’×•××™× â€“ ×¤×™× ×” ×©×××œ×™×ª ×ª×—×ª×•× ×”
                    const blockW = 14 + 6 + 20;       // ×¨×•×—×‘ ×“×¨×š ×”×§×©×¨ + ×¨×•×•×— + ×¨×•×—×‘ ×œ×™× ×§-×§××¨
                    const startX = (pageWidth - blockW) / 2;
                    
                    pdf.addImage('branco.jpg', 'JPEG', startX,         pageHeight - 26, 14, 14);
                    pdf.addImage('link_car.png',       'PNG',  startX + 14 + 6, pageHeight - 24, 20, 8);



                }

                progressFill.style.width = '100%';
                progressText.textContent = '×”×•×©×œ×!';
                const orgPart = subjectiveOrgName ? `_${subjectiveOrgName}` : '';
                pdf.save(`× ×™×ª×•×—_×©××œ×•×Ÿ_×¡×•×‘×™×™×§×˜×™×‘×™${orgPart}.pdf`);
                setTimeout(() => { modal.style.display = 'none'; }, 500);
            } catch (err) {
                alert('×©×’×™××”: ' + err.message);
                modal.style.display = 'none';
            }
        }

        function subjectiveExportExcel() {
            if (!subjectiveProcessedData) return;

            const { groups, availableBehaviorCols } = subjectiveProcessedData;
            const wsData = [['×›×™×ª×”', '×ª×—×•×', '×¢×¨×š 3', '×¢×¨×š 4', '×¢×¨×š 5', '××—×¨', '×¡×”×´×›']];
            
            Object.keys(groups).sort().forEach(groupName => {
                const filtered = groups[groupName].filter(row => parseFloat(row.behavior_main) === 2);
                if (filtered.length === 0) return;
                
                availableBehaviorCols.forEach(col => {
                    const N = filtered.length;
                    let count3 = 0, count4 = 0, count5 = 0;
                    filtered.forEach(row => {
                        const val = parseFloat(row[col]);
                        if (val === 3) count3++;
                        else if (val === 4) count4++;
                        else if (val === 5) count5++;
                    });
                    wsData.push([groupName, BEHAVIOR_COLUMNS[col], count3, count4, count5, N - count3 - count4 - count5, N]);
                });
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, '× ×™×ª×•×— ×”×ª× ×”×’×•×ª');
            XLSX.writeFile(wb, 'behavior_analysis.xlsx');
        }

        function subjectiveReset() {
            subjectiveDashboard.classList.remove('active');
            subjectiveDashboard.innerHTML = '';
            subjectiveUploadCard.style.display = 'block';
            subjectiveFileInput.value = '';
            subjectiveGlobalLegend.style.display = 'none';
            subjectiveProcessedData = null;
            subjectiveGroupElements = [];
        }
    </script>
    <div class="footer">
        ×›×œ×™ × ×™×ª×•×— ××‘× ×™ ×“×¨×š ×”×ª×¤×ª×—×•×ª×™×•×ª | × ×‘× ×” ×¢× â¤ï¸
        
    </div>
</body>
</html>
